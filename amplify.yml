# Amplify build configuration for Next.js (App Router, Next 15)
# Docs: https://docs.aws.amazon.com/amplify/latest/userguide/build-settings.html
# This file aligns the artifact directory with the custom Next.js distDir (.next-build)
# If you remove `distDir` from next.config.js change `artifacts.baseDirectory` back to `.next`.

version: 1
frontend:
  phases:
    preBuild:
      commands:
        # Ensure Node 20 (matches package.json engines and Next.js 15 requirements)
        - nvm install 20 || true
        - nvm use 20 || true
        # Print versions for easier debugging
        - node --version
        - npm --version
        # Install dependencies (ci = clean reproducible install)
        - npm ci
        # Fail fast if required environment variables are missing
        - npm run env:check
        # (Optional) run env diagnostics script(s) if you have any
        # - npm run diagnostics:100ms || true
    build:
      commands:
        # Write selected environment variables to .env.production so Next.js server code
        # can read them at runtime (Amplify build environment -> .env.production).
        - echo "--- Writing selected env vars to .env.production ---"
        - env | grep -e MONGODB_URI -e MONGODB_DB -e JWT_SECRET >> .env.production || true
        - env | grep -e NEXT_PUBLIC_ >> .env.production || true
        # Build the Next.js project (produces next-build because of custom distDir)
        - npm run build
        # (Optional) run type-check or lint in CI without failing deployment
        # - npm run type-check || true
        # - npm run lint || true
    postBuild:
      commands:
        - echo "--- Post-build: verify artifact directory ---"
        - if [ -d "next-build" ]; then echo "Found next-build:" && ls -la next-build | sed -n '1,200p'; else echo "next-build not found. Listing root:" && ls -la | sed -n '1,200p'; fi
        - du -sh next-build || true
  artifacts:
  # Must match the custom distDir in next.config.js
  baseDirectory: next-build
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
     