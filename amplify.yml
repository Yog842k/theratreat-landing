# Amplify build configuration for Next.js (App Router, Next 15)
# Docs: https://docs.aws.amazon.com/amplify/latest/userguide/build-settings.html
# This file aligns the artifact directory with the custom Next.js distDir (.next-build)
# If you remove `distDir` from next.config.js change `artifacts.baseDirectory` back to `.next`.

version: 1
frontend:
  phases:
    preBuild:
      commands:
        - nvm install 20
        - nvm use 20
        - echo "Cleaning node_modules and cache..."
        - rm -rf node_modules
        - npm cache clean --force
        - echo "Installing dependencies..."
        - npm install
        - echo "Forcing install of PostCSS & Autoprefixer..."
        - npm install autoprefixer postcss --force --save-dev
        - echo "Verify autoprefixer version:"
        - npx autoprefixer --version || echo "Autoprefixer installed manually"
        - if [ -z "$DATABASE_URL" ]; then echo "DATABASE_URL env var missing. Set it in Amplify environment variables."; exit 1; fi
        - if [ -z "$MONGODB_URI" ]; then echo "MONGODB_URI env var missing. Set it in Amplify environment variables."; exit 1; fi
        - |
          cat > .env.production <<'EOF'
          DATABASE_URL=$DATABASE_URL
          MONGODB_URI=$MONGODB_URI
          MONGODB_DB=${MONGODB_DB:-theratreat}
          JWT_SECRET=$JWT_SECRET
          ADMIN_EMAIL=$ADMIN_EMAIL
          ADMIN_PASSWORD=$ADMIN_PASSWORD
          CLOUDINARY_API_KEY=$CLOUDINARY_API_KEY
          CLOUDINARY_API_SECRET=$CLOUDINARY_API_SECRET
          CLOUDINARY_CLOUD_NAME=$CLOUDINARY_CLOUD_NAME
          GEMINI_API_KEY=$GEMINI_API_KEY
          HMS_ACCESS_KEY=$HMS_ACCESS_KEY
          HMS_MANAGEMENT_TOKEN=$HMS_MANAGEMENT_TOKEN
          HMS_REGION=${HMS_REGION:-IN}
          HMS_SECRET=$HMS_SECRET
          HMS_SUBDOMAIN=$HMS_SUBDOMAIN
          HMS_TEMPLATE_ID=$HMS_TEMPLATE_ID
          IDFY_CLIENT_ID=$IDFY_CLIENT_ID
          IDFY_CLIENT_SECRET=$IDFY_CLIENT_SECRET
          NEXT_PUBLIC_GOOGLE_MAPS_API_KEY=$NEXT_PUBLIC_GOOGLE_MAPS_API_KEY
          NEXT_PUBLIC_RAZORPAY_KEY_ID=$NEXT_PUBLIC_RAZORPAY_KEY_ID
          RAZORPAY_KEY_ID=$RAZORPAY_KEY_ID
          RAZORPAY_KEY_SECRET=$RAZORPAY_KEY_SECRET
          SENDGRID_API_KEY=$SENDGRID_API_KEY
          SENDGRID_FROM_EMAIL=$SENDGRID_FROM_EMAIL
          SHIPROCKET_EMAIL=$SHIPROCKET_EMAIL
          SHIPROCKET_PASSWORD=$SHIPROCKET_PASSWORD
          TWILIO_ACCOUNT_SID=$TWILIO_ACCOUNT_SID
          TWILIO_AUTH_TOKEN=$TWILIO_AUTH_TOKEN
          TWILIO_SMS_FROM=$TWILIO_SMS_FROM
          NODE_ENV=${NODE_ENV:-production}
          EOF
        - cp .env.production .env.local
        - echo "env vars written to .env.production/.env.local"
    build:
      commands:
        - echo "Starting build..."
        - node scripts/write-next-env.mjs
        - npm run build
    postBuild:
      commands:
        - "echo '--- Post-build: verify artifact directory ---'"
        # Simpler logging without complex inline condition (avoid YAML parsing edge cases)
        - "test -d next-build && echo 'Found next-build directory' || echo 'next-build directory NOT found'"
        - "(ls -la next-build 2>/dev/null || ls -la) | sed -n '1,120p'"
        - "du -sh next-build || true"
  artifacts:
    # Must match the custom distDir in next.config.js
    baseDirectory: next-build
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
