# Amplify build configuration for Next.js (App Router, Next 15)
# Docs: https://docs.aws.amazon.com/amplify/latest/userguide/build-settings.html
# This file aligns the artifact directory with the custom Next.js distDir (.next-build)
# If you remove `distDir` from next.config.js change `artifacts.baseDirectory` back to `.next`.

version: 1
frontend:
  phases:
    preBuild:
      commands:
        - npm cache clean --force
        - rm -rf node_modules
        - npm install
        - export NODE_ENV=production
        # Ensure Node 20 (matches package.json engines and Next.js 15 requirements)
        - "nvm install 20 || true"
        - "nvm use 20 || true"
        # Print versions for easier debugging
        - "node --version"
        - "npm --version"
        # Install dependencies (ci = clean reproducible install)
        - "npm ci"
        # Fail fast if required environment variables are missing
        - "npm run env:check"
        # (Optional) run env diagnostics script(s) if you have any
        # - npm run diagnostics:100ms || true
    build:
      commands:
        # Generate .env.production from a curated whitelist (see scripts/write-next-env.mjs)
        # SECURITY: Anything written to .env.production is embedded in build artifacts.
        # Remove vars from write-next-env.mjs if you do not want them stored there.
        - "node scripts/write-next-env.mjs"
        # Build the Next.js project (produces next-build because of custom distDir)
        - "npm run build"
        # (Optional) run type-check or lint in CI without failing deployment
        # - npm run type-check || true
        # - npm run lint || true
    postBuild:
      commands:
        - "echo '--- Post-build: verify artifact directory ---'"
        # Simpler logging without complex inline condition (avoid YAML parsing edge cases)
        - "test -d next-build && echo 'Found next-build directory' || echo 'next-build directory NOT found'"
        - "(ls -la next-build 2>/dev/null || ls -la) | sed -n '1,120p'"
        - "du -sh next-build || true"
  artifacts:
    # Must match the custom distDir in next.config.js
    baseDirectory: next-build
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
